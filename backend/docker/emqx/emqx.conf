## FaithFlow EMQX Configuration
## EMQX 5.x Configuration File
##
## For production, ensure you:
## 1. Change dashboard password
## 2. Enable SSL/TLS
## 3. Configure JWT authentication with your secret
## 4. Disable anonymous access

## ============================================================================
## Node Configuration
## ============================================================================

node {
    name = "emqx@127.0.0.1"
    cookie = "faithflow-emqx-cookie"
    data_dir = "/opt/emqx/data"
}

## ============================================================================
## Dashboard Configuration
## ============================================================================

dashboard {
    listeners {
        http {
            bind = "0.0.0.0:18083"
            max_connections = 512
        }
    }
    # Default: admin / public - CHANGE IN PRODUCTION via env var
}

## ============================================================================
## MQTT Listeners
## ============================================================================

listeners {
    tcp {
        default {
            bind = "0.0.0.0:1883"
            max_connections = 100000
            proxy_protocol = false
        }
    }

    ws {
        default {
            bind = "0.0.0.0:8083"
            max_connections = 100000
            websocket {
                mqtt_path = "/mqtt"
                allow_origin_absence = true
                check_origin_enable = false
            }
        }
    }

    # SSL listeners (enable in production)
    # ssl {
    #     default {
    #         bind = "0.0.0.0:8883"
    #         max_connections = 100000
    #         ssl_options {
    #             keyfile = "/opt/emqx/etc/certs/key.pem"
    #             certfile = "/opt/emqx/etc/certs/cert.pem"
    #             cacertfile = "/opt/emqx/etc/certs/cacert.pem"
    #         }
    #     }
    # }

    # wss {
    #     default {
    #         bind = "0.0.0.0:8084"
    #         max_connections = 100000
    #         ssl_options {
    #             keyfile = "/opt/emqx/etc/certs/key.pem"
    #             certfile = "/opt/emqx/etc/certs/cert.pem"
    #         }
    #         websocket {
    #             mqtt_path = "/mqtt"
    #         }
    #     }
    # }
}

## ============================================================================
## MQTT Protocol Settings
## ============================================================================

mqtt {
    max_packet_size = 1MB
    max_clientid_len = 65535
    max_topic_levels = 128
    max_qos_allowed = 2
    max_topic_alias = 65535
    retain_available = true

    ## Inflight window
    max_inflight = 32

    ## Message queue
    max_mqueue_len = 1000
    mqueue_store_qos0 = true

    ## Session
    session_expiry_interval = "2h"

    ## Keep alive
    keepalive_multiplier = 1.5

    ## Idle timeout
    idle_timeout = "15s"

    ## For presence: Last Will and Testament
    await_rel_timeout = "300s"
}

## ============================================================================
## Authentication
## ============================================================================

## For development: No authentication (anonymous access)
## This allows any client to connect without credentials
authentication = []

## For production with built-in database:
## authentication = [
##     {
##         mechanism = password_based
##         backend = built_in_database
##         enable = true
##         user_id_type = username
##     }
## ]

## For production with JWT:
## authentication = [
##     {
##         mechanism = jwt
##         from = password
##         use_jwks = false
##         algorithm = "hmac-based"
##         secret = "${JWT_SECRET}"
##         verify_claims = {
##             sub = "%u"
##         }
##     }
## ]

## ============================================================================
## Authorization
## ============================================================================

## For development: Allow all (no ACL restrictions)
authorization {
    no_match = allow
    deny_action = disconnect
    cache {
        enable = true
        max_size = 32
        ttl = "1m"
    }
    ## No sources = allow everything
    sources = []
}

## ============================================================================
## Retainer (for presence and last messages)
## ============================================================================

retainer {
    enable = true
    msg_clear_interval = "0s"
    msg_expiry_interval = "1h"
    max_payload_size = "1MB"
    flow_control {
        batch_read_number = 0
        batch_deliver_number = 0
    }
    backend {
        type = built_in_database
        storage_type = disc
        max_retained_messages = 100000
    }
}

## ============================================================================
## Logging
## ============================================================================

log {
    console {
        enable = true
        level = info
    }
    file {
        default {
            enable = true
            level = warning
            path = "/opt/emqx/log/emqx.log"
            rotation_count = 10
            rotation_size = "50MB"
        }
    }
}
